apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: requeue
  namespace: abuse-api-dev
  labels:
    app: requeue
spec:
  schedule: "*/5 * * * *"

  # Deadline in seconds for starting the job if it misses its scheduled time.
  startingDeadlineSeconds: 60

  concurrencyPolicy: Forbid

  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3

  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: requeue
        spec:
          restartPolicy: OnFailure
          imagePullSecrets:
            - name: dcu-artifactory-creds
          containers:
            - name: requeue
              imagePullPolicy: Always
              image: docker-dcu-local.artifactory.secureserver.net/requeue:dev
              env:
                - name: sysenv
                  value: "dev"
                - name: BUILD_DATE
                  value: "Fri Apr 22 10:13:43 CDT 2022"
                # TODO CMAPT-5032: remove single_broker and queue_type
                - name: QUEUE_TYPE
                  valueFrom:
                    configMapKeyRef:
                      name: quorum-migration
                      key: queuetype
                - name: SINGLE_BROKER
                  valueFrom:
                    secretKeyRef:
                      name: amqp-connection-string-v2
                      key: url
                - name: MULTIPLE_BROKERS
                  valueFrom:
                    secretKeyRef:
                      name: amqp-shared-creds
                      key: multiple_brokers_pdna
